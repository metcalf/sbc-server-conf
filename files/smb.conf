# Secure Samba Configuration for Raspberry Pi Backup Server
# /etc/samba/smb.conf

[global]
# Basic server settings
workgroup = WORKGROUP
server string = Home Server
netbios name = HOMESERVER

# Protocol and security settings - SMB3 minimum for maximum security
min protocol = SMB3
max protocol = SMB3
server min protocol = SMB3
client min protocol = SMB3

# Require encryption for all connections
server smb encrypt = required
smb encrypt = required

# Authentication and security
security = user
map to guest = never
restrict anonymous = 2
guest account = nobody
invalid users = root nobody

# Password settings
unix password sync = no

# Network and performance settings
dead time = 15

# Logging
log file = /var/log/samba/log.smbd
log level = 1
max log size = 50000

# Disable unnecessary services
load printers = no
printing = bsd
printcap name = /dev/null
disable spoolss = yes
show add printer wizard = no

# File system settings
unix extensions = yes
wide links = no
follow symlinks = no

# Prevent common attacks
hosts deny = ALL
hosts allow = 192.168.0.0/22 127.0.0.1
bind interfaces only = yes
interfaces = eth0 lo

# Hide system files and improve security
; hide dot files = yes
hide special files = yes
hide unreadable = yes
hide unwriteable files = yes

# Time server (optional)
time server = no

# Apple compatibility
fruit:aapl = yes
ea support = yes
store dos attributes = yes

# Example individual user backup shares with dedicated Samba users
[windows-backup]
comment = Windows Backup
path = /mnt/ExternalWindowsBackup
valid users = windowsbackup, andrew
read only = no
browseable = yes
writable = yes
guest ok = no
create mask = 0600
directory mask = 0700

[timemachine-backup]
comment = Time Machine Backup
path = /mnt/ExternalTimeMachine
valid users = timemachinebackup
read only = no
browseable = yes
writable = yes
guest ok = no
create mask = 0600
directory mask = 0700

# Essential Time Machine options
fruit:time machine = yes
fruit:time machine max size = 750G  # Optional: set max backup size
vfs objects = catia fruit streams_xattr

# Performance and compatibility
fruit:metadata = stream
fruit:model = MacSamba
fruit:posix_rename = yes
fruit:veto_appledouble = no
fruit:wipe_intentionally_left_blank_rfork = yes
fruit:delete_empty_adfiles = yes

[misc]
comment = Miscellaneous
path = /mnt/ExternalMisc
valid users = miscbackup, andrew
force user = miscbackup
read only = no
browseable = yes
writable = yes
guest ok = no
create mask = 0600
directory mask = 0700

# Same VFS objects for consistency
vfs objects = catia fruit streams_xattr
# Non-Time Machine fruit settings
fruit:time machine = no
